{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/app/api/admin/diagnostics/database/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\nexport async function GET() {\r\n  const issues: any[] = []\r\n  const warnings: any[] = []\r\n  const stats: any = {}\r\n\r\n  try {\r\n    // 1. Check Leads Table\r\n    const { data: leads, count: leadsCount, error: leadsError } = await supabase\r\n      .from('leads')\r\n      .select('*', { count: 'exact' })\r\n\r\n    if (leadsError) {\r\n      issues.push({\r\n        severity: 'critical',\r\n        table: 'leads',\r\n        issue: 'Cannot query leads table',\r\n        error: leadsError.message,\r\n      })\r\n    } else {\r\n      stats.totalLeads = leadsCount || 0\r\n\r\n      // Check for leads with missing email\r\n      const missingEmail = leads?.filter(l => !l.email).length || 0\r\n      if (missingEmail > 0) {\r\n        warnings.push({\r\n          severity: 'warning',\r\n          table: 'leads',\r\n          issue: `${missingEmail} leads missing email addresses`,\r\n          count: missingEmail,\r\n        })\r\n      }\r\n\r\n      // Check for duplicate emails\r\n      const emails = leads?.map(l => l.email).filter(Boolean) || []\r\n      const duplicates = emails.filter((e, i) => emails.indexOf(e) !== i)\r\n      if (duplicates.length > 0) {\r\n        warnings.push({\r\n          severity: 'warning',\r\n          table: 'leads',\r\n          issue: `${duplicates.length} duplicate email addresses found`,\r\n          duplicates: [...new Set(duplicates)],\r\n        })\r\n      }\r\n\r\n      // Check status distribution\r\n      const statuses: any = {}\r\n      leads?.forEach(l => {\r\n        statuses[l.status] = (statuses[l.status] || 0) + 1\r\n      })\r\n      stats.leadStatuses = statuses\r\n    }\r\n\r\n    // 2. Check Sites Table\r\n    const { data: sites, count: sitesCount, error: sitesError } = await supabase\r\n      .from('sites')\r\n      .select('*', { count: 'exact' })\r\n\r\n    if (sitesError) {\r\n      issues.push({\r\n        severity: 'critical',\r\n        table: 'sites',\r\n        issue: 'Cannot query sites table',\r\n        error: sitesError.message,\r\n      })\r\n    } else {\r\n      stats.totalSites = sitesCount || 0\r\n\r\n      // Check for sites without preview URL\r\n      const missingPreview = sites?.filter(s => !s.preview_url).length || 0\r\n      if (missingPreview > 0) {\r\n        warnings.push({\r\n          severity: 'warning',\r\n          table: 'sites',\r\n          issue: `${missingPreview} sites missing preview URLs`,\r\n          count: missingPreview,\r\n        })\r\n      }\r\n\r\n      // Check for orphaned sites (no lead_id)\r\n      const orphaned = sites?.filter(s => !s.lead_id).length || 0\r\n      if (orphaned > 0) {\r\n        issues.push({\r\n          severity: 'error',\r\n          table: 'sites',\r\n          issue: `${orphaned} orphaned sites (no lead_id)`,\r\n          count: orphaned,\r\n        })\r\n      }\r\n    }\r\n\r\n    // 3. Check Subscriptions Table\r\n    const { data: subscriptions, count: subsCount, error: subsError } = await supabase\r\n      .from('subscriptions')\r\n      .select('*', { count: 'exact' })\r\n\r\n    if (subsError) {\r\n      issues.push({\r\n        severity: 'critical',\r\n        table: 'subscriptions',\r\n        issue: 'Cannot query subscriptions table',\r\n        error: subsError.message,\r\n      })\r\n    } else {\r\n      stats.totalSubscriptions = subsCount || 0\r\n\r\n      const activeCount = subscriptions?.filter(s => s.status === 'active').length || 0\r\n      stats.activeSubscriptions = activeCount\r\n\r\n      // Calculate MRR\r\n      const mrr = subscriptions\r\n        ?.filter(s => s.status === 'active')\r\n        .reduce((sum, s) => sum + parseFloat(s.amount?.toString() || '0'), 0) || 0\r\n      stats.mrr = Math.round(mrr * 100) / 100\r\n\r\n      // Calculate ARR\r\n      stats.arr = Math.round(mrr * 12 * 100) / 100\r\n\r\n      // Check for subscriptions without lead_id\r\n      const noLead = subscriptions?.filter(s => !s.lead_id).length || 0\r\n      if (noLead > 0) {\r\n        warnings.push({\r\n          severity: 'warning',\r\n          table: 'subscriptions',\r\n          issue: `${noLead} subscriptions without lead_id`,\r\n          count: noLead,\r\n        })\r\n      }\r\n    }\r\n\r\n    // 4. Check Email Logs\r\n    const { count: emailsSent, error: emailError } = await supabase\r\n      .from('email_logs')\r\n      .select('*', { count: 'exact', head: true })\r\n\r\n    if (!emailError) {\r\n      stats.totalEmailsSent = emailsSent || 0\r\n\r\n      const { count: emailsOpened } = await supabase\r\n        .from('email_logs')\r\n        .select('*', { count: 'exact', head: true })\r\n        .not('opened_at', 'is', null)\r\n\r\n      stats.emailsOpened = emailsOpened || 0\r\n      stats.openRate = emailsSent && emailsSent > 0\r\n        ? Math.round((emailsOpened! / emailsSent) * 100 * 10) / 10\r\n        : 0\r\n    }\r\n\r\n    // 5. Calculate Conversion Metrics\r\n    const leadsContacted = leads?.filter(l => l.email_sent_at).length || 0\r\n    stats.leadsContacted = leadsContacted\r\n\r\n    stats.conversionRate = leadsContacted > 0\r\n      ? Math.round((stats.activeSubscriptions / leadsContacted) * 100 * 10) / 10\r\n      : 0\r\n\r\n    // 6. Check for data integrity issues\r\n    if (stats.conversionRate > 100) {\r\n      issues.push({\r\n        severity: 'critical',\r\n        calculation: 'conversion_rate',\r\n        issue: `Conversion rate is ${stats.conversionRate}% (impossible - must be â‰¤100%)`,\r\n        activeSubscriptions: stats.activeSubscriptions,\r\n        leadsContacted: stats.leadsContacted,\r\n      })\r\n    }\r\n\r\n    // 7. Check QA Reviews\r\n    const { count: qaCount } = await supabase\r\n      .from('qa_reviews')\r\n      .select('*', { count: 'exact', head: true })\r\n\r\n    stats.totalQAReviews = qaCount || 0\r\n\r\n    // 8. Check Support Tickets\r\n    const { count: ticketsCount } = await supabase\r\n      .from('support_tickets')\r\n      .select('*', { count: 'exact', head: true })\r\n\r\n    stats.totalSupportTickets = ticketsCount || 0\r\n\r\n    const { count: openTickets } = await supabase\r\n      .from('support_tickets')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('status', 'open')\r\n\r\n    stats.openSupportTickets = openTickets || 0\r\n\r\n    return NextResponse.json({\r\n      status: 'complete',\r\n      summary: {\r\n        totalIssues: issues.length,\r\n        totalWarnings: warnings.length,\r\n        criticalIssues: issues.filter(i => i.severity === 'critical').length,\r\n      },\r\n      issues,\r\n      warnings,\r\n      stats,\r\n      timestamp: new Date().toISOString(),\r\n    })\r\n\r\n  } catch (error: any) {\r\n    return NextResponse.json({\r\n      status: 'error',\r\n      error: error.message,\r\n      issues: [{\r\n        severity: 'critical',\r\n        issue: 'Diagnostic scan failed',\r\n        error: error.message,\r\n      }],\r\n    }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}