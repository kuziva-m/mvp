{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/lib/queues.ts"],"sourcesContent":["import { Queue } from \"bullmq\";\r\nimport Redis from \"ioredis\";\r\n\r\n// FIX: Use global type to prevent TS errors and reuse connection across hot reloads\r\nconst globalForRedis = global as unknown as { redis: Redis };\r\n\r\n// Singleton Redis connection\r\nlet connection: Redis | null = null;\r\n\r\nfunction getRedisConnection(): Redis {\r\n  // Skip Redis connection during build time to prevent build failures\r\n  if (process.env.NEXT_PHASE === \"phase-production-build\") {\r\n    throw new Error(\"Redis not available during build\");\r\n  }\r\n\r\n  // Use REDIS_CONNECTION_STRING first to avoid conflicts with system REDIS_URL\r\n  const redisUrl = process.env.REDIS_CONNECTION_STRING || process.env.REDIS_URL;\r\n\r\n  if (!redisUrl) {\r\n    throw new Error(\r\n      \"REDIS_CONNECTION_STRING or REDIS_URL is required. Get free Redis from https://upstash.com\"\r\n    );\r\n  }\r\n\r\n  // Validate it's a redis:// URL\r\n  if (!redisUrl.startsWith(\"redis://\") && !redisUrl.startsWith(\"rediss://\")) {\r\n    throw new Error(\r\n      \"Redis URL must start with redis:// or rediss:// (found: \" +\r\n        redisUrl.substring(0, 10) +\r\n        \"...)\"\r\n    );\r\n  }\r\n\r\n  // FIX: Return existing global connection if in development\r\n  if (globalForRedis.redis) {\r\n    return globalForRedis.redis;\r\n  }\r\n\r\n  // Create new connection if none exists\r\n  if (!connection) {\r\n    connection = new Redis(redisUrl, {\r\n      maxRetriesPerRequest: null,\r\n      enableReadyCheck: false,\r\n      lazyConnect: true,\r\n      retryStrategy: (times) => {\r\n        return Math.min(times * 50, 2000);\r\n      },\r\n      reconnectOnError: (err) => {\r\n        const targetErrors = [\"READONLY\", \"ECONNRESET\"];\r\n        return targetErrors.some((e) => err.message.includes(e));\r\n      },\r\n    });\r\n\r\n    connection.on(\"connect\", () => {\r\n      console.log(\"âœ… Redis connected\");\r\n    });\r\n\r\n    connection.on(\"error\", (error) => {\r\n      if (!error.message.includes(\"ECONNRESET\")) {\r\n        console.error(\"âŒ Redis error:\", error.message);\r\n      }\r\n    });\r\n\r\n    // Connect immediately\r\n    connection.connect().catch(() => {}); // Catch initial connect error to prevent crash\r\n  }\r\n\r\n  // FIX: Save to global scope in development/non-production\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    globalForRedis.redis = connection;\r\n  }\r\n\r\n  return connection;\r\n}\r\n\r\n// Lazy queue initialization\r\nlet _leadProcessingQueue: Queue | null = null;\r\nlet _siteGenerationQueue: Queue | null = null;\r\nlet _emailSendingQueue: Queue | null = null;\r\nlet _deliveryQueue: Queue | null = null;\r\n\r\nexport const leadProcessingQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_leadProcessingQueue) {\r\n      const connection = getRedisConnection();\r\n      _leadProcessingQueue = new Queue(\"lead-processing\", { connection });\r\n    }\r\n    return (_leadProcessingQueue as any)[prop];\r\n  },\r\n});\r\n\r\nexport const siteGenerationQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_siteGenerationQueue) {\r\n      const connection = getRedisConnection();\r\n      _siteGenerationQueue = new Queue(\"site-generation\", { connection });\r\n    }\r\n    return (_siteGenerationQueue as any)[prop];\r\n  },\r\n});\r\n\r\nexport const emailSendingQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_emailSendingQueue) {\r\n      const connection = getRedisConnection();\r\n      _emailSendingQueue = new Queue(\"email-sending\", { connection });\r\n    }\r\n    return (_emailSendingQueue as any)[prop];\r\n  },\r\n});\r\n\r\nexport const deliveryQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_deliveryQueue) {\r\n      const connection = getRedisConnection();\r\n      _deliveryQueue = new Queue(\"delivery\", { connection });\r\n    }\r\n    return (_deliveryQueue as any)[prop];\r\n  },\r\n});\r\n\r\n// Helper: Add job to queue\r\nexport async function addJobToQueue(\r\n  queue: Queue,\r\n  jobName: string,\r\n  data: any,\r\n  options: any = {}\r\n) {\r\n  try {\r\n    const job = await queue.add(jobName, data, {\r\n      attempts: 3,\r\n      backoff: {\r\n        type: \"exponential\",\r\n        delay: 2000,\r\n      },\r\n      removeOnComplete: {\r\n        count: 1000,\r\n        age: 7 * 24 * 60 * 60, // 7 days\r\n      },\r\n      removeOnFail: {\r\n        count: 5000,\r\n        age: 30 * 24 * 60 * 60, // 30 days\r\n      },\r\n      ...options,\r\n    });\r\n\r\n    return job;\r\n  } catch (error) {\r\n    console.error(`Failed to add job to ${queue.name}:`, error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// Helper: Get queue status\r\nexport async function getQueueStatus(queue: Queue) {\r\n  const [waiting, active, completed, failed, delayed, paused] =\r\n    await Promise.all([\r\n      queue.getWaitingCount(),\r\n      queue.getActiveCount(),\r\n      queue.getCompletedCount(),\r\n      queue.getFailedCount(),\r\n      queue.getDelayedCount(),\r\n      queue.isPaused(),\r\n    ]);\r\n\r\n  return {\r\n    name: queue.name,\r\n    waiting,\r\n    active,\r\n    completed,\r\n    failed,\r\n    delayed,\r\n    paused,\r\n    total: waiting + active,\r\n  };\r\n}\r\n\r\n// Helper: Get all queue statuses\r\nexport async function getAllQueueStatuses() {\r\n  const queues = [\r\n    leadProcessingQueue,\r\n    siteGenerationQueue,\r\n    emailSendingQueue,\r\n    deliveryQueue,\r\n  ];\r\n\r\n  return Promise.all(queues.map((queue) => getQueueStatus(queue)));\r\n}\r\n\r\n// Helper: Pause/Resume queues\r\nexport async function pauseAllQueues() {\r\n  await Promise.all([\r\n    leadProcessingQueue.pause(),\r\n    siteGenerationQueue.pause(),\r\n    emailSendingQueue.pause(),\r\n    deliveryQueue.pause(),\r\n  ]);\r\n  console.log(\"â¸ï¸ All queues paused\");\r\n}\r\n\r\nexport async function resumeAllQueues() {\r\n  await Promise.all([\r\n    leadProcessingQueue.resume(),\r\n    siteGenerationQueue.resume(),\r\n    emailSendingQueue.resume(),\r\n    deliveryQueue.resume(),\r\n  ]);\r\n  console.log(\"â–¶ï¸ All queues resumed\");\r\n}\r\n\r\n// Helper: Clear queue\r\nexport async function clearQueue(queue: Queue) {\r\n  await queue.drain();\r\n  await queue.clean(0, 1000, \"completed\");\r\n  await queue.clean(0, 1000, \"failed\");\r\n  console.log(`ðŸ—‘ï¸ Queue ${queue.name} cleared`);\r\n}\r\n\r\n// Helper: Get failed jobs\r\nexport async function getFailedJobs(queue: Queue, limit: number = 50) {\r\n  const failed = await queue.getFailed(0, limit);\r\n  return failed.map((job) => ({\r\n    id: job.id,\r\n    name: job.name,\r\n    data: job.data,\r\n    failedReason: job.failedReason,\r\n    attemptsMade: job.attemptsMade,\r\n    timestamp: job.timestamp,\r\n  }));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/app/api/admin/queues/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { getAllQueueStatuses } from '@/lib/queues'\r\n\r\nexport async function GET() {\r\n  try {\r\n    const statuses = await getAllQueueStatuses()\r\n    return NextResponse.json({ success: true, queues: statuses })\r\n  } catch (error) {\r\n    // Return empty queues if Redis is unavailable\r\n    console.error('Queue status error:', error)\r\n    return NextResponse.json({\r\n      success: true,\r\n      queues: [],\r\n      error: 'Redis connection unavailable'\r\n    })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,sIAAmB;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,QAAQ;QAAS;IAC7D,EAAE,OAAO,OAAO;QACd,8CAA8C;QAC9C,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,QAAQ,EAAE;YACV,OAAO;QACT;IACF;AACF"}}]
}