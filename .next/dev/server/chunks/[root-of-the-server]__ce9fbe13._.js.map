{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\n// Supabase configuration\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\nif (!supabaseUrl || !supabaseServiceRoleKey) {\r\n  throw new Error('Missing Supabase environment variables')\r\n}\r\n\r\n// Create Supabase client (server-side only, uses service role key)\r\nexport const supabase = createClient(supabaseUrl, supabaseServiceRoleKey, {\r\n  auth: {\r\n    autoRefreshToken: false,\r\n    persistSession: false,\r\n    detectSessionInUrl: false,\r\n  },\r\n})\r\n\r\n// Types for better TypeScript support\r\nexport type Database = {\r\n  public: {\r\n    Tables: {\r\n      leads: {\r\n        Row: {\r\n          id: string\r\n          business_name: string\r\n          email: string | null\r\n          website: string | null\r\n          phone: string | null\r\n          industry: string\r\n          status: string\r\n          source: string\r\n          scraped_data: any | null\r\n          quality_score: number | null\r\n          email_sent_at: string | null\r\n          email_opened_at: string | null\r\n          email_clicked_at: string | null\r\n          email_replied_at: string | null\r\n          automation_paused: string | null\r\n          created_at: string\r\n          updated_at: string\r\n        }\r\n        Insert: {\r\n          id?: string\r\n          business_name: string\r\n          email?: string | null\r\n          website?: string | null\r\n          phone?: string | null\r\n          industry: string\r\n          status?: string\r\n          source?: string\r\n          scraped_data?: any | null\r\n          quality_score?: number | null\r\n          email_sent_at?: string | null\r\n          email_opened_at?: string | null\r\n          email_clicked_at?: string | null\r\n          email_replied_at?: string | null\r\n          automation_paused?: string | null\r\n          created_at?: string\r\n          updated_at?: string\r\n        }\r\n        Update: {\r\n          id?: string\r\n          business_name?: string\r\n          email?: string | null\r\n          website?: string | null\r\n          phone?: string | null\r\n          industry?: string\r\n          status?: string\r\n          source?: string\r\n          scraped_data?: any | null\r\n          quality_score?: number | null\r\n          email_sent_at?: string | null\r\n          email_opened_at?: string | null\r\n          email_clicked_at?: string | null\r\n          email_replied_at?: string | null\r\n          automation_paused?: string | null\r\n          created_at?: string\r\n          updated_at?: string\r\n        }\r\n      }\r\n      // We'll add more tables in Prompt 3\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,yBAAyB;AACzB,MAAM;AACN,MAAM,yBAAyB,QAAQ,GAAG,CAAC,yBAAyB;AAEpE,IAAI,CAAC,eAAe,CAAC,wBAAwB;IAC3C,MAAM,IAAI,MAAM;AAClB;AAGO,MAAM,WAAW,IAAA,yLAAY,EAAC,aAAa,wBAAwB;IACxE,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;QAChB,oBAAoB;IACtB;AACF"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/lib/modules/customer-success/health-scorer.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase'\r\n\r\nexport interface HealthScore {\r\n  leadId: string\r\n  healthScore: number // 0-100\r\n  engagementScore: number\r\n  satisfactionScore: number\r\n  riskLevel: 'low' | 'medium' | 'high' | 'critical'\r\n  churnProbability: number\r\n  factors: {\r\n    daysSinceActivity: number\r\n    supportTickets: number\r\n    paymentIssues: number\r\n    engagement: string\r\n  }\r\n}\r\n\r\nexport async function calculateHealthScore(leadId: string): Promise<HealthScore> {\r\n  console.log(`ðŸ’Š Calculating health score for: ${leadId}`)\r\n\r\n  // Get customer data\r\n  const { data: lead } = await supabase\r\n    .from('leads')\r\n    .select('*, subscriptions(*), support_tickets(*)')\r\n    .eq('id', leadId)\r\n    .single()\r\n\r\n  if (!lead) {\r\n    throw new Error('Lead not found')\r\n  }\r\n\r\n  // Factor 1: Engagement (40 points)\r\n  let engagementScore = 0\r\n\r\n  // Check last activity (email opens, clicks, site visits)\r\n  const daysSinceCreated = Math.floor(\r\n    (Date.now() - new Date(lead.created_at).getTime()) / (1000 * 60 * 60 * 24)\r\n  )\r\n\r\n  const daysSinceActivity = lead.email_clicked_at\r\n    ? Math.floor((Date.now() - new Date(lead.email_clicked_at).getTime()) / (1000 * 60 * 60 * 24))\r\n    : daysSinceCreated\r\n\r\n  if (daysSinceActivity <= 7) engagementScore = 40\r\n  else if (daysSinceActivity <= 14) engagementScore = 30\r\n  else if (daysSinceActivity <= 30) engagementScore = 20\r\n  else if (daysSinceActivity <= 60) engagementScore = 10\r\n  else engagementScore = 0\r\n\r\n  // Factor 2: Support tickets (30 points)\r\n  const totalTickets = lead.support_tickets?.length || 0\r\n  const unresolvedTickets = lead.support_tickets?.filter((t: any) => t.status !== 'resolved').length || 0\r\n\r\n  let supportScore = 30\r\n  if (unresolvedTickets > 0) supportScore -= (unresolvedTickets * 10)\r\n  if (totalTickets > 5) supportScore -= 10\r\n  supportScore = Math.max(0, supportScore)\r\n\r\n  // Factor 3: Payment health (30 points)\r\n  const subscription = lead.subscriptions?.[0]\r\n  let paymentScore = 30\r\n\r\n  if (subscription?.status === 'past_due') paymentScore = 10\r\n  else if (subscription?.status === 'canceled') paymentScore = 0\r\n\r\n  // Calculate overall health score\r\n  const healthScore = Math.round(engagementScore + supportScore + paymentScore)\r\n\r\n  // Determine risk level\r\n  let riskLevel: 'low' | 'medium' | 'high' | 'critical'\r\n  if (healthScore >= 80) riskLevel = 'low'\r\n  else if (healthScore >= 60) riskLevel = 'medium'\r\n  else if (healthScore >= 40) riskLevel = 'high'\r\n  else riskLevel = 'critical'\r\n\r\n  // Calculate churn probability\r\n  const churnProbability = Math.round(100 - healthScore)\r\n\r\n  // Determine satisfaction (simplified - in production, use survey data)\r\n  const satisfactionScore = Math.min(100, healthScore + 10)\r\n\r\n  console.log(`âœ… Health score: ${healthScore}/100 (${riskLevel} risk)`)\r\n\r\n  return {\r\n    leadId,\r\n    healthScore,\r\n    engagementScore,\r\n    satisfactionScore,\r\n    riskLevel,\r\n    churnProbability,\r\n    factors: {\r\n      daysSinceActivity,\r\n      supportTickets: totalTickets,\r\n      paymentIssues: subscription?.status === 'past_due' ? 1 : 0,\r\n      engagement: daysSinceActivity <= 7 ? 'active' : daysSinceActivity <= 30 ? 'moderate' : 'low',\r\n    },\r\n  }\r\n}\r\n\r\n// Save health score to database\r\nexport async function saveHealthScore(health: HealthScore) {\r\n  await supabase\r\n    .from('customer_health')\r\n    .upsert({\r\n      lead_id: health.leadId,\r\n      health_score: health.healthScore,\r\n      engagement_score: health.engagementScore,\r\n      satisfaction_score: health.satisfactionScore,\r\n      risk_level: health.riskLevel,\r\n      churn_probability: health.churnProbability,\r\n      last_activity_at: new Date().toISOString(),\r\n      days_since_activity: health.factors.daysSinceActivity,\r\n      total_support_tickets: health.factors.supportTickets,\r\n      payment_failures: health.factors.paymentIssues,\r\n      last_calculated_at: new Date().toISOString(),\r\n    }, {\r\n      onConflict: 'lead_id',\r\n    })\r\n}\r\n\r\n// Get all at-risk customers\r\nexport async function getAtRiskCustomers() {\r\n  const { data } = await supabase\r\n    .from('customer_health')\r\n    .select('*, leads(business_name, email)')\r\n    .in('risk_level', ['high', 'critical'])\r\n    .order('health_score', { ascending: true })\r\n\r\n  return data || []\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/app/api/admin/customer-success/at-risk/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { getAtRiskCustomers } from '@/lib/modules/customer-success/health-scorer'\r\n\r\nexport async function GET() {\r\n  try {\r\n    const atRisk = await getAtRiskCustomers()\r\n    return NextResponse.json({ atRisk })\r\n  } catch (error) {\r\n    console.error('Failed to get at-risk customers:', error)\r\n    return NextResponse.json({ error: 'Failed to get at-risk customers' }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,iLAAkB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAO;IACpC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkC,GAAG;YAAE,QAAQ;QAAI;IACvF;AACF"}}]
}