{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/lib/queues.ts"],"sourcesContent":["import { Queue, Worker, QueueEvents } from 'bullmq'\r\nimport Redis from 'ioredis'\r\n\r\n// Singleton Redis connection to prevent multiple connections in Next.js\r\nlet connection: Redis | null = null\r\nlet isConnected = false\r\n\r\nfunction getRedisConnection(): Redis {\r\n  // Skip Redis connection during build time\r\n  if (process.env.NEXT_PHASE === 'phase-production-build') {\r\n    throw new Error('Redis not available during build')\r\n  }\r\n\r\n  // Use REDIS_CONNECTION_STRING first to avoid conflicts with system REDIS_URL\r\n  const redisUrl = process.env.REDIS_CONNECTION_STRING || process.env.REDIS_URL\r\n\r\n  if (!redisUrl) {\r\n    throw new Error('REDIS_CONNECTION_STRING or REDIS_URL is required. Get free Redis from https://upstash.com')\r\n  }\r\n\r\n  // Validate it's a redis:// URL, not https://\r\n  if (!redisUrl.startsWith('redis://') && !redisUrl.startsWith('rediss://')) {\r\n    throw new Error('Redis URL must start with redis:// or rediss:// (found: ' + redisUrl.substring(0, 10) + '...)')\r\n  }\r\n\r\n  if (!connection) {\r\n    connection = new Redis(redisUrl, {\r\n      maxRetriesPerRequest: null,\r\n      enableReadyCheck: false,\r\n      lazyConnect: true,\r\n      retryStrategy: (times) => {\r\n        const delay = Math.min(times * 50, 2000)\r\n        return delay\r\n      },\r\n      reconnectOnError: (err) => {\r\n        const targetErrors = ['READONLY', 'ECONNRESET']\r\n        return targetErrors.some(e => err.message.includes(e))\r\n      },\r\n    })\r\n\r\n    // Connection monitoring (only log once)\r\n    connection.on('connect', () => {\r\n      if (!isConnected) {\r\n        console.log('âœ… Redis connected')\r\n        isConnected = true\r\n      }\r\n    })\r\n\r\n    let errorCount = 0\r\n    const MAX_ERROR_LOGS = 3\r\n\r\n    connection.on('error', (error) => {\r\n      // Suppress noisy ECONNRESET errors in development\r\n      if (error.message.includes('ECONNRESET')) {\r\n        if (errorCount < MAX_ERROR_LOGS) {\r\n          console.error('âŒ Redis connection unstable (ECONNRESET)')\r\n          errorCount++\r\n          if (errorCount === MAX_ERROR_LOGS) {\r\n            console.error('âš ï¸ Redis errors suppressed. Install local Redis: see INSTALL_REDIS_WINDOWS.md')\r\n          }\r\n        }\r\n        return\r\n      }\r\n      console.error('âŒ Redis error:', error.message)\r\n    })\r\n\r\n    // Connect immediately\r\n    connection.connect().catch((err) => {\r\n      if (!err.message.includes('ECONNRESET')) {\r\n        console.error('Failed to connect to Redis:', err.message)\r\n      }\r\n    })\r\n  }\r\n\r\n  return connection\r\n}\r\n\r\n// Lazy queue initialization to prevent build-time issues\r\nlet _leadProcessingQueue: Queue | null = null\r\nlet _siteGenerationQueue: Queue | null = null\r\nlet _emailSendingQueue: Queue | null = null\r\nlet _deliveryQueue: Queue | null = null\r\n\r\nexport const leadProcessingQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_leadProcessingQueue) {\r\n      const connection = getRedisConnection()\r\n      _leadProcessingQueue = new Queue('lead-processing', { connection })\r\n    }\r\n    return (_leadProcessingQueue as any)[prop]\r\n  }\r\n})\r\n\r\nexport const siteGenerationQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_siteGenerationQueue) {\r\n      const connection = getRedisConnection()\r\n      _siteGenerationQueue = new Queue('site-generation', { connection })\r\n    }\r\n    return (_siteGenerationQueue as any)[prop]\r\n  }\r\n})\r\n\r\nexport const emailSendingQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_emailSendingQueue) {\r\n      const connection = getRedisConnection()\r\n      _emailSendingQueue = new Queue('email-sending', { connection })\r\n    }\r\n    return (_emailSendingQueue as any)[prop]\r\n  }\r\n})\r\n\r\nexport const deliveryQueue = new Proxy({} as Queue, {\r\n  get(target, prop) {\r\n    if (!_deliveryQueue) {\r\n      const connection = getRedisConnection()\r\n      _deliveryQueue = new Queue('delivery', { connection })\r\n    }\r\n    return (_deliveryQueue as any)[prop]\r\n  }\r\n})\r\n\r\n// Helper: Add job to queue\r\nexport async function addJobToQueue(\r\n  queue: Queue,\r\n  jobName: string,\r\n  data: any,\r\n  options: any = {}\r\n) {\r\n  try {\r\n    const job = await queue.add(jobName, data, {\r\n      attempts: 3,\r\n      backoff: {\r\n        type: 'exponential',\r\n        delay: 2000,\r\n      },\r\n      removeOnComplete: {\r\n        count: 1000,\r\n        age: 7 * 24 * 60 * 60, // 7 days\r\n      },\r\n      removeOnFail: {\r\n        count: 5000,\r\n        age: 30 * 24 * 60 * 60, // 30 days\r\n      },\r\n      ...options,\r\n    })\r\n\r\n    return job\r\n  } catch (error) {\r\n    console.error(`Failed to add job to ${queue.name}:`, error)\r\n    throw error\r\n  }\r\n}\r\n\r\n// Helper: Get queue status\r\nexport async function getQueueStatus(queue: Queue) {\r\n  const [waiting, active, completed, failed, delayed, paused] = await Promise.all([\r\n    queue.getWaitingCount(),\r\n    queue.getActiveCount(),\r\n    queue.getCompletedCount(),\r\n    queue.getFailedCount(),\r\n    queue.getDelayedCount(),\r\n    queue.isPaused(),\r\n  ])\r\n\r\n  return {\r\n    name: queue.name,\r\n    waiting,\r\n    active,\r\n    completed,\r\n    failed,\r\n    delayed,\r\n    paused,\r\n    total: waiting + active,\r\n  }\r\n}\r\n\r\n// Helper: Get all queue statuses\r\nexport async function getAllQueueStatuses() {\r\n  const queues = [\r\n    leadProcessingQueue,\r\n    siteGenerationQueue,\r\n    emailSendingQueue,\r\n    deliveryQueue,\r\n  ]\r\n\r\n  return Promise.all(queues.map(queue => getQueueStatus(queue)))\r\n}\r\n\r\n// Helper: Pause/Resume queues\r\nexport async function pauseAllQueues() {\r\n  await Promise.all([\r\n    leadProcessingQueue.pause(),\r\n    siteGenerationQueue.pause(),\r\n    emailSendingQueue.pause(),\r\n    deliveryQueue.pause(),\r\n  ])\r\n  console.log('â¸ï¸ All queues paused')\r\n}\r\n\r\nexport async function resumeAllQueues() {\r\n  await Promise.all([\r\n    leadProcessingQueue.resume(),\r\n    siteGenerationQueue.resume(),\r\n    emailSendingQueue.resume(),\r\n    deliveryQueue.resume(),\r\n  ])\r\n  console.log('â–¶ï¸ All queues resumed')\r\n}\r\n\r\n// Helper: Clear queue\r\nexport async function clearQueue(queue: Queue) {\r\n  await queue.drain()\r\n  await queue.clean(0, 1000, 'completed')\r\n  await queue.clean(0, 1000, 'failed')\r\n  console.log(`ðŸ—‘ï¸ Queue ${queue.name} cleared`)\r\n}\r\n\r\n// Helper: Get failed jobs\r\nexport async function getFailedJobs(queue: Queue, limit: number = 50) {\r\n  const failed = await queue.getFailed(0, limit)\r\n  return failed.map(job => ({\r\n    id: job.id,\r\n    name: job.name,\r\n    data: job.data,\r\n    failedReason: job.failedReason,\r\n    attemptsMade: job.attemptsMade,\r\n    timestamp: job.timestamp,\r\n  }))\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 390, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Kuziv/Desktop/Desktop%20Folders/Client%20Projects/MVp/mvp-web-agency/app/api/admin/workers/health/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { getAllQueueStatuses } from '@/lib/queues'\r\n\r\nexport async function GET() {\r\n  try {\r\n    // Get queue statuses\r\n    const queues = await getAllQueueStatuses()\r\n\r\n    // Infer worker health from queue activity\r\n    const workers = queues.map(queue => {\r\n      const failureRate = queue.completed > 0\r\n        ? (queue.failed / (queue.completed + queue.failed)) * 100\r\n        : 0\r\n\r\n      const healthy = queue.failed < 10 && !queue.paused && failureRate < 5\r\n\r\n      return {\r\n        name: queue.name,\r\n        healthy,\r\n        waiting: queue.waiting,\r\n        active: queue.active,\r\n        completed: queue.completed,\r\n        failed: queue.failed,\r\n        delayed: queue.delayed,\r\n        paused: queue.paused,\r\n        failureRate: parseFloat(failureRate.toFixed(2)),\r\n      }\r\n    })\r\n\r\n    const allHealthy = workers.every(w => w.healthy)\r\n    const totalActive = workers.reduce((sum, w) => sum + w.active, 0)\r\n    const totalCompleted = workers.reduce((sum, w) => sum + w.completed, 0)\r\n    const totalFailed = workers.reduce((sum, w) => sum + w.failed, 0)\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      overall: allHealthy ? 'healthy' : 'unhealthy',\r\n      workers,\r\n      summary: {\r\n        totalActive,\r\n        totalCompleted,\r\n        totalFailed,\r\n        allHealthy,\r\n      },\r\n      timestamp: new Date().toISOString(),\r\n    })\r\n  } catch (error) {\r\n    console.error('Health check error:', error)\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        overall: 'error',\r\n        error: 'Health check failed',\r\n        timestamp: new Date().toISOString(),\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,qBAAqB;QACrB,MAAM,SAAS,MAAM,IAAA,sIAAmB;QAExC,0CAA0C;QAC1C,MAAM,UAAU,OAAO,GAAG,CAAC,CAAA;YACzB,MAAM,cAAc,MAAM,SAAS,GAAG,IAClC,AAAC,MAAM,MAAM,GAAG,CAAC,MAAM,SAAS,GAAG,MAAM,MAAM,IAAK,MACpD;YAEJ,MAAM,UAAU,MAAM,MAAM,GAAG,MAAM,CAAC,MAAM,MAAM,IAAI,cAAc;YAEpE,OAAO;gBACL,MAAM,MAAM,IAAI;gBAChB;gBACA,SAAS,MAAM,OAAO;gBACtB,QAAQ,MAAM,MAAM;gBACpB,WAAW,MAAM,SAAS;gBAC1B,QAAQ,MAAM,MAAM;gBACpB,SAAS,MAAM,OAAO;gBACtB,QAAQ,MAAM,MAAM;gBACpB,aAAa,WAAW,YAAY,OAAO,CAAC;YAC9C;QACF;QAEA,MAAM,aAAa,QAAQ,KAAK,CAAC,CAAA,IAAK,EAAE,OAAO;QAC/C,MAAM,cAAc,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,MAAM,EAAE;QAC/D,MAAM,iBAAiB,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,SAAS,EAAE;QACrE,MAAM,cAAc,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,MAAM,EAAE;QAE/D,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS,aAAa,YAAY;YAClC;YACA,SAAS;gBACP;gBACA;gBACA;gBACA;YACF;YACA,WAAW,IAAI,OAAO,WAAW;QACnC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,SAAS;YACT,OAAO;YACP,WAAW,IAAI,OAAO,WAAW;QACnC,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}